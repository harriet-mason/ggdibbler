---
title: "Nested Positions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{nested-positions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ggplot2)
library(ggdibbler)
library(patchwork)
```

### Position Nesting
One of the most powerful features of `ggdibbler` is the ability to do nested positions. That is, you can control the overplotting in the original plot, *and* the over plotting caused by resampling using separate positions. This can create some interested graphics. 

Below is a grid of box plots. The first column is the original ggplot we are going to add uncertainty to, the second and third column is the effect of the overplotting being managed with an nested identity (with decreased alpha) and dodge positions respectively. The syntax of the nested positions is `mainposition_nestedposition`, where the main position is what was in the original ggplot, and the nested position manages the overplotting caused by sampling from the distribution. 

```{r, fig.width=16, fig.height=16}
# ggplot IDENTITY
p1 <- ggplot(mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv), 
                  position = "identity", alpha=0.7)+
  theme(legend.position="none", aspect.ratio = 1) +
  ggtitle("ggplot2: identity")
# ggdibbler identity
p2 <- ggplot(uncertain_mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv), alpha=0.1,
                  position = "identity_identity")+
  theme(legend.position="none", aspect.ratio = 1)+
  ggtitle("identity_identity")

p3 <- ggplot(uncertain_mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv), alpha=0.7,
                  position = "identity_dodge")+
  theme(legend.position="none", aspect.ratio = 1)+
  ggtitle("identity_dodge")


# ggplot dodge
p5 <- ggplot(mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv), 
                  position = position_dodge(preserve="single"))+
  theme(legend.position="none", aspect.ratio = 1)+
  ggtitle("ggplot: dodge")

p6 <- ggplot(uncertain_mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv), alpha=0.1,
                  position = "dodge_identity")+
  theme(legend.position="none", aspect.ratio = 1)+
  ggtitle("dodge_identity")

p7 <- ggplot(uncertain_mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv), 
                  position = "dodge_dodge")+
  theme(legend.position="none", aspect.ratio = 1)+
  ggtitle("dodge_dodge")


# ggplot stack
p9 <- ggplot(mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv), 
                  position = "stack")+
  theme(legend.position="none", aspect.ratio = 1)+
  ggtitle("ggplot2: stack")


p10 <- ggplot(uncertain_mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv), alpha=0.1,
                  position = "stack_identity")+
  theme(legend.position="none", aspect.ratio = 1)+
  ggtitle("stack_identity")

p11 <- ggplot(uncertain_mpg, aes(class)) + 
  geom_bar_sample(aes(fill = drv),
                  position = "stack_dodge")+
  theme(legend.position="none", aspect.ratio = 1)+
  ggtitle("stack_dodge")


(p1 | p2 | p3 ) / (p5 | p6 | p7) / (p9 | p10 | p11)
```


# Nested position examples
```{r, eval=FALSE}
ggplot(smaller_diamonds, aes(carat, after_stat(count), fill = cut)) +
  geom_density(aes(colour=cut), position = "stack") #ggplot
ggplot(smaller_uncertain_diamonds, aes(carat, after_stat(count), fill = cut)) +
  geom_density_sample(aes(colour = after_stat(fill)),
                          position = "stack_identity", alpha=0.15)+
  theme(palette.fill.discrete = "viridis",
        palette.colour.discrete = "viridis")
```

```{r, eval=FALSE}
# If you want to dodge bars and errorbars, you need to manually
# specify the dodge width
# ggplot
p <- ggplot(df, aes(trt, resp, fill = group))
p +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = "dodge", width = 0.25)
# NEED NESTED POSITION - POSITION_DODGE_IDENTITY OR EVEN POSITION_DODGE_DODGE
# THIS DOES POSITION_DODGE_DODGE THE OTHER WAY AROUND (MAIN PLOT INSIDE OF DIST)
# ggdibbler
q <- ggplot(uncertain_df, aes(trt, resp, fill = group))
q +
  geom_col_sample(position = "dodge_identity") +
  geom_errorbar_sample(aes(ymin = lower, ymax = upper), 
                       position = "dodge_identity", width = 0.25)
# 
# Because the bars and errorbars have different widths
# we need to specify how wide the objects we are dodging are
# ggplot
dodge <- position_dodge(width=0.9)
dodge2 <- position_dodge_identity(width=0.9)
p +
  geom_col(position = dodge) +
  geom_errorbar(aes(ymin = lower, ymax = upper), position = dodge, width = 0.25)
# ggdibbler
q +
  geom_col_sample(position = dodge2) +
  geom_errorbar_sample(aes(ymin = lower, ymax = upper), position = dodge2, width = 0.25)

```
